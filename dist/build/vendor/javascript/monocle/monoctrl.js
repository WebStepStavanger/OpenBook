Monocle.Controls.Contents=function(t){function e(){var e=t.dom.make("div","controls_contents_container");return n(e,t.getBook()),e}function n(t,e){for(;t.hasChildNodes();)t.removeChild(t.firstChild);for(var n=t.dom.append("ol","controls_contents_list"),i=e.properties.contents,r=0;r<i.length;++r)o(n,i[r],0)}function o(t,e,n){var a=t.childNodes.length,s=t.dom.append("li","controls_contents_chapter",a),c=s.dom.append("span","controls_contents_chapterTitle",a,{html:e.title});c.style.paddingLeft=n+"em";var u=function(){r.reader.skipToChapter(e.src),r.reader.hideControl(i)};if(Monocle.Events.listenForTap(s,u,"controls_contents_chapter_active"),e.children)for(var h=0;h<e.children.length;++h)o(t,e.children[h],n+1)}var i={constructor:Monocle.Controls.Contents};i.constants=i.constructor;var r=i.properties={reader:t};return i.createControlElements=e,i},Monocle.Controls.Magnifier=function(t){function e(){a.reader=t}function n(t){var e=t.dom.make("div","controls_magnifier_button");return e.smallA=e.dom.append("span","controls_magnifier_a",{text:"A"}),e.largeA=e.dom.append("span","controls_magnifier_A",{text:"A"}),a.buttons.push(e),Monocle.Events.listenForTap(e,o),e}function o(){var t;a.magnified=!a.magnified,a.magnified?(t=[.3,1],a.reader.formatting.setFontScale(r.MAGNIFICATION,!0)):(t=[1,.3],a.reader.formatting.setFontScale(null,!0));for(var e=0;e<a.buttons.length;e++)a.buttons[e].smallA.style.opacity=t[0],a.buttons[e].largeA.style.opacity=t[1]}var i={constructor:Monocle.Controls.Magnifier},r=i.constants=i.constructor,a=i.properties={buttons:[],magnified:!1};return i.createControlElements=n,e(),i},Monocle.Controls.Magnifier.MAGNIFICATION=1.2,Monocle.Controls.Panel=function(){function t(t){return d.div=t.dom.make("div",f.CLS.panel),d.div.dom.setStyles(f.DEFAULT_STYLES),Monocle.Events.listenForContact(d.div,{start:i,move:r,end:a,cancel:s},{useCapture:!1}),d.div}function e(t){d.direction=t}function n(t){d.evtCallbacks=t}function o(){d.evtCallbacks={}}function i(t){d.contact=!0,t.m.offsetX+=d.div.offsetLeft,t.m.offsetY+=d.div.offsetTop,u(),c("start",t)}function r(t){d.contact&&c("move",t)}function a(t){d.contact&&(Monocle.Events.deafenForContact(d.div,d.listeners),h(),d.contact=!1,c("end",t))}function s(t){d.contact&&(Monocle.Events.deafenForContact(d.div,d.listeners),h(),d.contact=!1,c("cancel",t))}function c(t,e){d.evtCallbacks[t]&&d.evtCallbacks[t](d.direction,e.m.offsetX,e.m.offsetY,l),e.preventDefault()}function u(){d.expanded||(d.div.dom.addClass(f.CLS.expanded),d.expanded=!0)}function h(){d.expanded&&(d.div.dom.removeClass(f.CLS.expanded),d.expanded=!1)}var l={constructor:Monocle.Controls.Panel},f=l.constants=l.constructor,d=l.properties={evtCallbacks:{}};return l.createControlElements=t,l.listenTo=n,l.deafen=o,l.expand=u,l.contract=h,l.setDirection=e,l},Monocle.Controls.Panel.CLS={panel:"panel",expanded:"controls_panel_expanded"},Monocle.Controls.Panel.DEFAULT_STYLES={position:"absolute",height:"100%"},Monocle.Controls.PlaceSaver=function(t){function e(){o(t)}function n(t){l.reader=t,l.reader.listen("monocle:turn",a)}function o(t){l.bkTitle=t.toLowerCase().replace(/[^a-z0-9]/g,""),l.prefix=h.COOKIE_NAMESPACE+l.bkTitle+"."}function i(t,e,n){var o="";if(n){var i=new Date;i.setTime(i.getTime()+1e3*60*60*24*n),o="; expires="+i.toGMTString()}var r="; path=/";return document.cookie=l.prefix+t+"="+e+o+r,e}function r(t){if(!document.cookie)return null;var e=new RegExp(l.prefix+t+"=(.+?)(;|$)"),n=document.cookie.match(e);return n?n[1]:null}function a(){var t=l.reader.getPlace();i("component",encodeURIComponent(t.componentId()),h.COOKIE_EXPIRES_IN_DAYS),i("percent",t.percentageThrough(),h.COOKIE_EXPIRES_IN_DAYS)}function s(){var t={componentId:r("component"),percent:r("percent")};return t.componentId&&t.percent?(t.componentId=decodeURIComponent(t.componentId),t.percent=parseFloat(t.percent),t):null}function c(){var t=s();t&&l.reader.moveTo(t)}var u={constructor:Monocle.Controls.PlaceSaver},h=u.constants=u.constructor,l=u.properties={};return u.assignToReader=n,u.savedPlace=s,u.restorePlace=c,e(),u},Monocle.Controls.PlaceSaver.COOKIE_NAMESPACE="monocle.controls.placesaver.",Monocle.Controls.PlaceSaver.COOKIE_EXPIRES_IN_DAYS=7,Monocle.Controls.Scrubber=function(t){function e(){u.reader=t,u.reader.listen("monocle:turn",i),i()}function n(t,e){u.componentIds||(u.componentIds=u.reader.getBook().properties.componentIds,u.componentWidth=100/u.componentIds.length);var n=100*(t/e.offsetWidth),o=u.componentIds[Math.floor(n/u.componentWidth)],i=n%u.componentWidth/u.componentWidth;return{componentId:o,percentageThrough:i}}function o(t,e){u.componentIds||(u.componentIds=u.reader.getBook().properties.componentIds,u.componentWidth=100/u.componentIds.length);var n=u.componentIds.indexOf(t.componentId()),o=u.componentWidth*n;return o+=t.percentageThrough()*u.componentWidth,Math.round(o/100*e.offsetWidth)}function i(){if(!u.hidden&&u.reader.dom.find(c.CLS.container))for(var t,t,e=u.reader.getPlace(),n=o(e,u.reader.dom.find(c.CLS.container)),i=0,i=0;t=u.reader.dom.find(c.CLS.needle,i);++i)r(t,n-t.offsetWidth/2),u.reader.dom.find(c.CLS.trail,i).style.width=n+"px"}function r(t,e){var n=u.reader.dom.find(c.CLS.container);e=Math.min(n.offsetWidth-t.offsetWidth,e),e=Math.max(e,0),Monocle.Styles.setX(t,e)}function a(t){var e=t.dom.make("div",c.CLS.container);e.dom.append("div",c.CLS.track),e.dom.append("div",c.CLS.trail);var o,i,a=e.dom.append("div",c.CLS.needle),s=e.dom.append("div",c.CLS.bubble),h=function(t,o){t.preventDefault(),o="number"==typeof o?o:t.m.registrantX;var i=n(o,e);r(a,o-a.offsetWidth/2);var c=u.reader.getBook(),h=c.chaptersForComponent(i.componentId),l=u.componentIds.indexOf(i.componentId),f=h[Math.floor(h.length*i.percentageThrough)];if(l>-1&&c.properties.components[l]){var d=Monocle.Place.FromPercentageThrough(c.properties.components[l],i.percentageThrough);f=d.chapterInfo()||f}return f&&(s.innerHTML=f.title),r(s,o-s.offsetWidth/2),u.lastX=o,i},l=function(t){var n=h(t,u.lastX);u.reader.moveTo({percent:n.percentageThrough,componentId:n.componentId}),Monocle.Events.deafenForContact(e,o),Monocle.Events.deafenForContact(document.body,i),s.style.display="none"},f=function(t){s.style.display="block",h(t),o=Monocle.Events.listenForContact(e,{move:h}),i=Monocle.Events.listenForContact(document.body,{end:l})};return Monocle.Events.listenForContact(e,{start:f}),e}var s={constructor:Monocle.Controls.Scrubber},c=s.constants=s.constructor,u=s.properties={};return s.createControlElements=a,s.updateNeedles=i,e(),s},Monocle.Controls.Scrubber.CLS={container:"controls_scrubber_container",track:"controls_scrubber_track",needle:"controls_scrubber_needle",trail:"controls_scrubber_trail",bubble:"controls_scrubber_bubble"},Monocle.Controls.Spinner=function(t){function e(t){var e=t.dom.make("div","controls_spinner_anim");return c.divs.push(e),e}function n(t,e){var n=t;c.reader.listen(t,function(t){i(n,t)}),c.reader.listen(e,function(t){r(n,t)})}function o(){n("monocle:componentloading","monocle:componentloaded"),n("monocle:componentchanging","monocle:componentchange"),n("monocle:resizing","monocle:resize"),n("monocle:jumping","monocle:jump"),n("monocle:recalculating","monocle:recalculated")}function i(t,e){t=t||s.GENERIC_LABEL,c.repeaters[t]=!0,c.reader.showControl(a);var n=e&&e.m&&e.m.page?e.m.page:null;n||(c.global=!0);for(var o=0;o<c.divs.length;++o){var i=c.divs[o].parentNode.parentNode;n==i&&c.showForPages.push(n);var r=c.global||c.showForPages.indexOf(n)>=0;c.divs[o].style.display=r?"block":"none"}}function r(t){t=t||s.GENERIC_LABEL,c.repeaters[t]=!1;for(var e in c.repeaters)if(c.repeaters[e])return;c.global=!1,c.showForPages=[],c.reader.hideControl(a)}var a={constructor:Monocle.Controls.Spinner},s=a.constants=a.constructor,c=a.properties={reader:t,divs:[],spinCount:0,repeaters:{},showForPages:[]};return a.createControlElements=e,a.listenForUsualDelays=o,a.spin=i,a.spun=r,a},Monocle.Controls.Spinner.GENERIC_LABEL="generic",Monocle.Controls.Stencil=function(t,e){function n(t){e=e||m.DEFAULT_BEHAVIORS;for(var n=0,s=e.length;s>n;++n)o(e[n]);return y.container=t.dom.make("div",m.CLS.container),y.reader.listen("monocle:turning",r),y.reader.listen("monocle:turn:cancel",a),y.reader.listen("monocle:turn",i),y.reader.listen("monocle:stylesheetchange",i),y.reader.listen("monocle:resize",i),i(),y.container}function o(t){var e=new t(v);"function"!=typeof e.findElements&&console.warn('Missing "findElements" method for behavior: %o',e),"function"!=typeof e.fitMask&&console.warn('Missing "fitMask" method for behavior: %o',e),y.behaviors.push(e)}function i(){var t=y.reader.visiblePages();if(t&&t.length){var e=t[0],n=d(e);n&&(y.components[n]=null,u(e),c())}}function r(){y.container.style.display="none"}function a(){y.container.style.display="block"}function s(){for(;y.container.childNodes.length;)y.container.removeChild(y.container.lastChild)}function c(){var t=y.reader.visiblePages()[0],e=d(t);if(y.components[e]&&(p(t),s(),!y.disabled)){a();var n=y.components[e];n&&n.length&&h(t,n)}}function u(t){var e=d(t);if(!y.components[e]){y.components[e]=[];for(var n=t.m.activeFrame.contentDocument,o=l(t),i=0,r=y.behaviors.length;r>i;++i)for(var a=y.behaviors[i],s=a.findElements(n),c=0;c<s.length;++c){var u=s[c];if(u.getClientRects)for(var h=u.getClientRects(),f=0;f<h.length;f++)y.components[e].push({element:u,behavior:a,left:Math.ceil(h[f].left+o.l),top:Math.ceil(h[f].top),width:Math.floor(h[f].width),height:Math.floor(h[f].height)})}return y.components[e]}}function h(t,e){for(var n=l(t),o=[],i=0;i<e.length;++i)f(e[i],n.l,n.l+n.w)&&o.push(e[i]);for(i=0;i<o.length;++i){var r=o[i],a={left:r.left-n.l,top:r.top,width:r.width,height:r.height},s=b(r.element,r.behavior);s.dom.setStyles({display:"block",left:a.left+"px",top:a.top+"px",width:a.width+"px",height:a.height+"px",position:"absolute"}),s.stencilRect=a}}function l(t){return{l:t.m.offset||0,w:t.m.dimensions.properties.width}}function f(t,e,n){return t.left>=e&&t.left<n}function d(t){return t=t||y.reader.visiblePages()[0],t.m.activeFrame.m.component?t.m.activeFrame.m.component.properties.id:void 0}function p(t){cmpt=t.m.activeFrame.parentNode,y.container.dom.setStyles({left:cmpt.offsetLeft+"px",top:cmpt.offsetTop+"px"})}function b(t,e){var n=y.container.dom.append(e.maskTagName||"div",m.CLS.mask);return Monocle.Events.listenForContact(n,{start:function(){y.reader.dispatchEvent("monocle:magic:halt")},move:function(t){t.preventDefault()},end:function(){y.reader.dispatchEvent("monocle:magic:init")}}),e.fitMask(t,n),n}function g(){var t=m.CLS.highlights;y.container.dom.hasClass(t)?y.container.dom.removeClass(t):y.container.dom.addClass(t)}var v={constructor:Monocle.Controls.Stencil},m=v.constants=v.constructor,y=v.properties={reader:t,behaviors:[],components:{},masks:[]};return v.createControlElements=n,v.addBehavior=o,v.draw=c,v.update=i,v.toggleHighlights=g,v},Monocle.Controls.Stencil.CLS={container:"controls_stencil_container",mask:"controls_stencil_mask",highlights:"controls_stencil_highlighted"},Monocle.Controls.Stencil.Links=function(t){function e(e){var n=e.href;if(!e.getAttribute("target"))for(var o=n.match(/([^#]*)(#.*)?$/),i=o[1],r=o[2]||"",a=t.properties.reader.getBook().properties.componentIds,s=0,c=a.length;c>s;++s)if(i.substr(0-a[s].length)==a[s])return{internal:a[s]+r};return{external:n}}var n={constructor:Monocle.Controls.Stencil.Links};return n.maskTagName="a",n.findElements=function(t){return t.querySelectorAll("a[href]")},n.fitMask=function(n,o){var i=e(n);i.internal?(o.setAttribute("href",'javascript:"Skip to chapter"'),Monocle.Events.listen(o,"click",function(e){t.properties.reader.skipToChapter(i.internal),e.preventDefault()})):(o.setAttribute("href",i.external),o.setAttribute("target","_blank"),n.setAttribute("target","_blank"))},n},Monocle.Controls.Stencil.DEFAULT_BEHAVIORS=[Monocle.Controls.Stencil.Links];